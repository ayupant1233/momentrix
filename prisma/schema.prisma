generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  PHOTOGRAPHER
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  DRAFT
  REQUESTED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum BookingRequestStatus {
  SUBMITTED
  MATCHING
  BOOKED
  CANCELLED
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
}

enum SocialProvider {
  INSTAGRAM
  FACEBOOK
  X
}

model User {
  id                 String                @id @default(cuid())
  email              String                @unique
  passwordHash       String
  name               String?
  phone              String?
  role               UserRole              @default(CLIENT)
  digilockerId       String?
  digilockerVerified Boolean               @default(false)
  emailVerifiedAt    DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  photographerProfile PhotographerProfile?
  clientProfile       ClientProfile?
  bookingsAsClient    Booking[]            @relation("ClientBookings")
  bookingsAsPhotographer Booking[]         @relation("PhotographerBookings")
  threadsAsClient      ChatThread[]        @relation("ClientThreads")
  threadsAsPhotographer ChatThread[]       @relation("PhotographerThreads")
  messages             Message[]
  verificationRequests VerificationRequest[]
  reviewsWritten       Review[]            @relation("ClientReviews")
  bookingRequests      BookingRequest[]    @relation("ClientBookingRequests")
  follows              PhotographerFollow[] @relation("ClientFollows")
  postLikes            PostLike[]
  emailTokens          EmailVerificationToken[]
  socialAccounts       SocialAccount[]
}

model ClientProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  companyName  String?
  useCase      String?
  city         String?
  latitude     Float?
  longitude    Float?
  budgetMin    Int?
  budgetMax    Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model PhotographerProfile {
  id               String             @id @default(cuid())
  userId           String             @unique
  headline         String?
  bio              String?
  city             String?
  latitude         Float?
  longitude        Float?
  travelRadiusKm   Int                @default(15)
  hourlyRate       Int?
  halfDayRate      Int?
  fullDayRate      Int?
  currency         String             @default("INR")
  responseTimeHrs  Int?               @default(24)
  instagramHandle  String?
  websiteUrl       String?
  services         Json?
  tags             Json?
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt       DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user           User             @relation(fields: [userId], references: [id])
  portfolioItems PortfolioItem[]
  posts          Post[]
  availability   AvailabilitySlot[]
  reviews        Review[]
  followers      PhotographerFollow[]
}

model SocialAccount {
  id            String          @id @default(cuid())
  userId        String
  provider      SocialProvider
  handle        String
  displayName   String?
  followerCount Int             @default(0)
  profileUrl    String?
  accessToken   String?
  refreshToken  String?
  expiresAt     DateTime?
  verifiedAt    DateTime?
  rawProfile    Json?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
}

model PortfolioItem {
  id               String      @id @default(cuid())
  photographerId   String
  title            String
  description      String?
  mediaUrl         String
  mediaType        MediaType   @default(IMAGE)
  featured         Boolean     @default(false)
  capturedAt       DateTime?
  location         String?
  createdAt        DateTime    @default(now())

  photographer PhotographerProfile @relation(fields: [photographerId], references: [id], onDelete: Cascade)
}

model Post {
  id             String      @id @default(cuid())
  photographerId String
  title          String
  content        String?
  mediaUrls      Json?
  likes          Int         @default(0)
  saves          Int         @default(0)
  enquiries      Int         @default(0)
  createdAt      DateTime    @default(now())

  photographer PhotographerProfile @relation(fields: [photographerId], references: [id], onDelete: Cascade)
  likedBy      PostLike[]
}

model AvailabilitySlot {
  id               String      @id @default(cuid())
  photographerId   String
  startTime        DateTime
  endTime          DateTime
  isBooked         Boolean     @default(false)

  photographer PhotographerProfile @relation(fields: [photographerId], references: [id], onDelete: Cascade)
  booking      Booking?            @relation(fields: [bookingId], references: [id])
  bookingId    String?             @unique
}

model Booking {
  id               String        @id @default(cuid())
  clientId         String
  photographerId   String
  bookingRequestId String? @unique
  status           BookingStatus @default(REQUESTED)
  eventName        String?
  eventType        String?
  location         String?
  latitude         Float?
  longitude        Float?
  startTime        DateTime?
  endTime          DateTime?
  hoursRequested   Int?
  totalAmount      Int?
  currency         String        @default("INR")
  notes            String?
  deliverables     String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  client       User                @relation("ClientBookings", fields: [clientId], references: [id])
  photographer User                @relation("PhotographerBookings", fields: [photographerId], references: [id])
  availability AvailabilitySlot?
  review       Review?
  thread       ChatThread?
  bookingRequest BookingRequest? @relation(fields: [bookingRequestId], references: [id])
}

model ChatThread {
  id               String      @id @default(cuid())
  clientId         String
  photographerId   String
  bookingId        String?    @unique
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  client       User       @relation("ClientThreads", fields: [clientId], references: [id])
  photographer User       @relation("PhotographerThreads", fields: [photographerId], references: [id])
  booking      Booking?   @relation(fields: [bookingId], references: [id])
  messages     Message[]
}

model Message {
  id         String   @id @default(cuid())
  threadId   String
  senderId   String
  body       String
  sentAt     DateTime @default(now())
  readAt     DateTime?

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User       @relation(fields: [senderId], references: [id])
}

model VerificationRequest {
  id           String             @id @default(cuid())
  userId       String
  provider     String
  status       VerificationStatus @default(PENDING)
  requestData  Json?
  responseData Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Review {
  id             String   @id @default(cuid())
  bookingId      String   @unique
  photographerId String
  clientId       String
  rating         Int
  comment        String?
  createdAt      DateTime @default(now())

  booking      Booking             @relation(fields: [bookingId], references: [id])
  photographer PhotographerProfile @relation(fields: [photographerId], references: [id], onDelete: Cascade)
  client       User                 @relation("ClientReviews", fields: [clientId], references: [id])
}

model BookingRequest {
  id             String                @id @default(cuid())
  clientId       String
  status         BookingRequestStatus @default(SUBMITTED)
  eventName      String?
  eventType      String?
  location       String?
  latitude       Float?
  longitude      Float?
  startTime      DateTime?
  endTime        DateTime?
  hoursRequested Int?
  notes          String?
  deliverables   String?
  initialMessage String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  client  User     @relation("ClientBookingRequests", fields: [clientId], references: [id])
  booking Booking?
}

model PhotographerFollow {
  id             String              @id @default(cuid())
  clientId       String
  photographerId String
  createdAt      DateTime            @default(now())

  client       User                 @relation("ClientFollows", fields: [clientId], references: [id])
  photographer PhotographerProfile  @relation(fields: [photographerId], references: [id], onDelete: Cascade)

  @@unique([clientId, photographerId])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@unique([postId, userId])
}

model EmailVerificationToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  consumedAt  DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}
